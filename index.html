<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA & Mobile App Meta Tags -->
    <title>AuraCode | Virtual Compiler</title>
    <meta name="description" content="Decentralized Code Execution Environment">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AuraCode">
    <meta name="theme-color" content="#09090b">
    <link id="manifest-link" rel="manifest" href="/manifest.json">

    <!-- External System Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    
    <!-- Project Modular Files -->
    <link rel="stylesheet" href="style.css">
</head>
<body class="h-screen flex flex-col overflow-hidden bg-[#09090b] text-zinc-100">

    <!-- Mandatory Local Storage & Policy Popup -->
    <div id="startup-overlay" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-xl flex items-center justify-center p-6">
        <div class="bg-zinc-900 border border-zinc-800 w-full max-w-md rounded-[2.5rem] p-10 shadow-2xl transition-all scale-in">
            <div class="w-16 h-16 bg-blue-600/10 rounded-2xl flex items-center justify-center mb-8">
                <i data-lucide="cpu" class="text-blue-500 w-8 h-8"></i>
            </div>
            <h2 class="text-2xl font-black text-white mb-4 tracking-tighter uppercase">Initialize Node</h2>
            <div class="space-y-4 text-zinc-400 text-sm leading-relaxed mb-10">
                <p>
                    <span class="text-white font-bold">AuraCode</span> is designed to be self-sufficient. To ensure maximum privacy and minimize server load, your entire execution environment is virtualized locally.
                </p>
                <div class="p-4 bg-black rounded-2xl border border-zinc-800">
                    <p class="text-[11px] font-mono text-blue-400">
                        SYSTEM DATA: All libraries (NumPy, Flask, etc.) and code snapshots are saved to <span class="underline">Browser IndexedDB</span>. We do not store your code on our servers.
                    </p>
                </div>
            </div>
            <div id="mount-controls">
                <button id="mount-btn" class="w-full py-4 bg-white text-black font-black rounded-2xl hover:bg-zinc-200 transition-all uppercase text-xs tracking-widest active:scale-95">
                    Mount Environment & Continue
                </button>
                <div id="mount-progress" class="text-xs text-zinc-400 mt-3 hidden">Initializing...</div>
            </div>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="h-16 border-b border-zinc-800 flex items-center justify-between px-4 sm:px-6 bg-zinc-950/50 backdrop-blur-md z-50 pt-[calc(env(safe-area-inset-top))]">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-2xl flex items-center justify-center font-black text-white italic shadow-lg shadow-blue-900/20">AC</div>
            <div class="hidden xs:block">
                <h1 class="text-sm font-black uppercase tracking-widest leading-none">AuraCode</h1>
                <span id="node-status" class="text-[9px] text-zinc-500 font-bold uppercase tracking-tighter">Waiting for Mount...</span>
            </div>
        </div>

        <div class="flex items-center gap-2 sm:gap-4">
            <!-- Language Engine Selector -->
            <div class="hidden md:flex bg-zinc-900 rounded-xl p-1 border border-zinc-800">
                <select id="lang-engine" class="bg-transparent text-[10px] font-black text-zinc-400 px-3 py-2 outline-none cursor-pointer uppercase">
                    <option value="python">Python 3.11</option>
                    <option value="javascript">JavaScript</option>
                    <option value="cpp">C++ (JSON Bridge)</option>
                </select>
            </div>

            <!-- Integrated Shield Scan Button -->
            <button onclick="AuraSystem.triggerAudit()" class="flex flex-col items-center justify-center p-2 px-3 bg-zinc-900 border border-zinc-800 rounded-xl active:scale-90 transition-all">
                <i data-lucide="shield" class="w-4 h-4 text-blue-400"></i>
                <span class="text-[7px] font-black text-blue-400 tracking-widest mt-1 uppercase">Tap</span>
            </button>

            <!-- Diagnostic Trigger -->
            <button onclick="AuraSystem.toggleSettings()" class="p-3 bg-zinc-900 border border-zinc-800 rounded-xl text-zinc-400 active:scale-90 relative">
                <i data-lucide="settings-2" class="w-5 h-5"></i>
                <div id="alert-indicator" class="hidden absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full animate-ping"></div>
            </button>

            <button onclick="AuraRunner.run()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2.5 rounded-xl text-[11px] font-black uppercase flex items-center gap-2 transition-all active:scale-95 shadow-xl shadow-blue-900/30">
                <i data-lucide="play" class="w-4 h-4 fill-current"></i> Run
            </button>
        </div>
    </nav>

    <!-- Main Workspace Area -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- Environment Sidebar -->
        <aside class="w-16 border-r border-zinc-800 flex flex-col items-center py-8 gap-10 bg-zinc-950">
            <button class="text-blue-500" title="Compiler"><i data-lucide="code-xml" class="w-6 h-6"></i></button>
            <button class="text-zinc-600 hover:text-white" title="FileSystem"><i data-lucide="folder-git-2" class="w-6 h-6"></i></button>
            <button class="text-zinc-600 hover:text-white" title="Package Hub"><i data-lucide="box" class="w-6 h-6"></i></button>
            <button class="text-zinc-600 hover:text-white mt-auto" title="Network Log"><i data-lucide="activity" class="w-6 h-6"></i></button>
        </aside>

        <!-- Editor & Terminal Controller -->
        <section class="flex-1 flex flex-col overflow-hidden">
            
            <!-- Code Editor Container -->
            <div class="flex-1 flex overflow-hidden bg-zinc-950">
                <!-- Line Numbers -->
                <div id="editor-gutter" class="w-14 pt-8 flex flex-col items-end pr-4 border-r border-zinc-900/50 text-[12px] font-mono text-zinc-700 leading-relaxed select-none">
                    1
                </div>
                <!-- Interactive Editor Area -->
                <textarea id="code-canvas" class="flex-1 p-8 font-mono text-sm outline-none resize-none bg-transparent text-zinc-300 placeholder-zinc-800 leading-relaxed" spellcheck="false" placeholder="# System ready for execution inputs..."></textarea>
            </div>

            <!-- Intelligent Hybrid Terminal -->
            <div id="aura-terminal" class="h-2/5 bg-black border-t border-zinc-800 flex flex-col">
                <div class="flex items-center justify-between px-5 py-3 bg-zinc-900/40 border-b border-zinc-900">
                    <div class="flex items-center gap-4">
                        <span class="text-[10px] font-black text-zinc-500 uppercase tracking-widest flex items-center gap-2">
                            <i data-lucide="terminal" class="w-4 h-4 text-emerald-500"></i>
                            Aura-Term v1.0
                        </span>
                        <div id="runtime-badge" class="text-[9px] bg-zinc-800 px-2 py-0.5 rounded-md text-zinc-400 font-bold uppercase tracking-tighter">IDBFS Standard</div>
                    </div>
                    <div class="flex gap-6">
                        <button onclick="AuraTerminal.clear()" class="text-[10px] text-zinc-600 hover:text-white font-black uppercase tracking-widest">Clear</button>
                        <button class="text-zinc-600 hover:text-white"><i data-lucide="maximize-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
                
                <!-- Output Stream -->
                <div id="terminal-stream" class="flex-1 p-6 overflow-y-auto font-mono text-xs leading-relaxed text-zinc-400 scroll-smooth">
                    <div class="text-zinc-700 italic opacity-50 underline">Mounting local virtual node...</div>
                </div>

                <!-- Terminal Command Layer -->
                <div class="p-4 bg-[#050505] flex items-center gap-4 px-6 border-t border-zinc-900">
                    <span class="text-blue-500 font-black text-sm">‚ùØ</span>
                    <input type="text" id="terminal-input" class="bg-transparent flex-1 outline-none font-mono text-xs text-white placeholder-zinc-700" placeholder="Type commands (pip install / npm install / speaker on)..." onkeydown="AuraTerminal.executeCommand(event)">
                    
                    <!-- Voice Control Toggle -->
                    <button id="stt-trigger" onclick="AuraVoice.toggleSTT()" class="p-2 text-zinc-600 hover:text-blue-400 transition-colors">
                        <i data-lucide="mic" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Global Logic Bridge -->
    <script src="work.js"></script>
    <script>
        // Refresh icons on load
        window.onload = () => {
            lucide.createIcons();
            console.log("AuraCode: index.html structures established.");
        };
        // Register Service Worker for PWA offline support
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(() => console.log('AuraCode: Service Worker registered')).catch(() => console.log('AuraCode: SW registration failed'));
        }

        // Desktop-only enforcement: if running on a small/mobile viewport, show advisory and disable mount
        (function enforceDesktop() {
            const isMobile = /Mobi|Android|iPhone|iPad|Phone/i.test(navigator.userAgent) || window.innerWidth < 900;
            if (isMobile) {
                const overlay = document.getElementById('startup-overlay');
                const mountBtn = document.getElementById('mount-btn');
                mountBtn.disabled = true;
                mountBtn.classList.add('opacity-40', 'cursor-not-allowed');
                overlay.querySelector('h2').innerText = 'Desktop Recommended';
                overlay.querySelector('.space-y-4').innerHTML = `<p class="text-zinc-400">AuraCode's full virtual node experience requires a desktop browser for reliable execution and local storage. Please open this site on a desktop device. Your privacy and execution fidelity are best on desktop.</p>`;
            }
        })();

        // Robust mount button handler: show progress, disable while mounting, and call AuraSystem.mount()
        (function wireMountButton() {
            const btn = document.getElementById('mount-btn');
            const progress = document.getElementById('mount-progress');
            if (!btn) return;
            btn.addEventListener('click', async function () {
                if (btn.disabled) return;
                btn.disabled = true;
                btn.classList.add('opacity-40', 'cursor-not-allowed');
                if (progress) { progress.style.display = 'block'; progress.innerText = 'Mounting environment...'; }
                try {
                    if (typeof AuraSystem?.mount === 'function') {
                        await AuraSystem.mount();
                    } else {
                        console.error('AuraSystem.mount not available');
                        if (progress) progress.innerText = 'Mount function missing.';
                    }
                } catch (e) {
                    console.error('Mount error', e);
                    if (progress) progress.innerText = 'Mount failed: ' + (e?.message || e);
                } finally {
                    btn.disabled = false;
                    btn.classList.remove('opacity-40', 'cursor-not-allowed');
                    if (progress && !document.getElementById('startup-overlay')?.style.display === 'none') {
                        // keep message visible
                    }
                }
            });
        })();
    </script>
</body>
</html>

